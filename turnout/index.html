<!DOCTYPE html>
<head>
<!-- per http://leafletjs.com/examples/quick-start/ -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css"
   integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ=="
   crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"
   integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log=="
   crossorigin=""></script>
</head>
<body style="margin: 0">
<div class="sheffmap" style="height:100vh"
  data-url="2016turnout.json"
  data-column="turnout"
  data-label="labelTurnout"
  data-style="styleTurnout"
  ></div>
<script src="https://drj11.github.io/sheffmap/sheffmap.js"></script>
<script>

labelTurnout = function(v, d, feature) {
  return feature.properties.name + " " + v + "%"
}

styleTurnout = function(v, d, descriptor) {
  return {
    fillOpacity:  0.01*v,
    fillColor: "purple",
  }
}

mapinate()

load("turnout.csv", function(xhr) {
  csvtext = xhr.responseText

  var rows = CSVParse(csvtext)
  rows.map(function(x){console.log(x)})
})

function CSVParse(text) {
  var t = text.replace(/\r\n/g, "\n")
  var CSV_RE = /[^",\r\n]+(,|\n)|"(?:[^"]|"")*"(,|\n)|(,|\n)/g

  var rows = []
  var row = []
  while(1) {
    var m = CSV_RE.exec(t)
    if(m == null) {
      break
    }
    if(row.length == 0) {
      rows.push(row)
    }
    var item = m[0]
    var rowEnd = /\n$/.test(item)
    item = item.substr(0, item.length-1)

    row.push(item)
    console.log("item", item, m.index, CSV_RE.lastIndex)
    if(rowEnd) {
      row = []
    }
  }
  return rows
}

</script>
</body>
